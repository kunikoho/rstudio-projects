---
title: "Vorticity - non PCA"
author: "Sirish Shrestha"
date: "August 25, 2017"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Echo Vorticity Analysis


#### Load packages
```{r, include=FALSE}
suppressPackageStartupMessages(library(tidyverse))
suppressPackageStartupMessages(library(cluster))
suppressPackageStartupMessages(library(factoextra))
suppressPackageStartupMessages(library(dendextend))
suppressPackageStartupMessages(library(rcompanion))
suppressPackageStartupMessages(library(purrr))
suppressPackageStartupMessages(library(dplyr))
suppressPackageStartupMessages(library(graphics))
suppressPackageStartupMessages(library(RColorBrewer))


library(tidyverse)  # data manipulation
library(cluster)    # clustering algorithms
library(factoextra) # clustering visualization
library(dendextend) # for comparing two dendrograms
library(rcompanion)
library(purrr)
library(dplyr)
library(graphics)
library(RColorBrewer)

```

#### Read the data for vorticity analysis
```{r vorticity}



setwd("C:/Users/siris/Documents/rstudio-projects/vorticity")

## read all echo data
echo <- read.csv("data.csv", header = TRUE, sep = ",", stringsAsFactors = TRUE)

#echo$Gender <- factor(echo$Gender)
#echo$NYHA <- factor(echo$NYHA)
#echo$Etiology <- factor(echo$Etiology)

names(echo)[1] <- "ID"

dim(echo)

#remove the diastolic data and ID for heatmap
echo.matrix <- data.matrix(echo[,-c(1,61:64)])
echo.matrix <- scale(echo.matrix)


heatmap(echo.matrix, Rowv = NA, Colv = NA, cm.colors(256))

#summary(echo)
#str(echo)

## There are several missing data. We only select the ones we care about - the vortex data.
vorticity.data <- echo.matrix[,c(44:51)]

summary(vorticity.data)

#scaled voriticity
heatmap(vorticity.data)


#
plot(data.frame(vorticity.data))



mar <- par()$mar
par(mar=mar+c(0,5,0,0))

# seems like the variables are in different scales
#barplot(sapply(data.frame(vorticity.data), var), horiz=T, las=1, cex.names=0.8)

# in log scale
#barplot(sapply(data.frame(vorticity.data), var), horiz=T, las=1, cex.names=0.8, log='x')
#par(mar=mar)


```


###Hierarchical Clustering packages

```{r}

# Dissimilarity matrix
d <- dist(vorticity.data, method = "euclidean")

# Hierarchical clustering using Complete Linkage
hc1 <- hclust(d, method = "complete" )

# Plot the obtained dendrogram
plot(hc1, cex = 0.6, hang = -1)



```



## For Hierarchical Clustering

#### using Agnes to check the cluster structure

```{r, echo=TRUE}


# methods to assess
m <- c( "average", "single", "complete", "ward")
names(m) <- c( "average", "single", "complete", "ward")

# function to compute coefficient
ac <- function(x) {
  agnes(vorticity.data, method = x)$ac
}

map_dbl(m, ac)
##  average    single  complete      ward 
##0.7656333 0.6595636 0.8810995 0.9480419 


```

### we select Ward's method since it's the strongest structure

```{r}

vorticity.data.frame <- data.frame(vorticity.data)


# Ward's method
hc5 <- hclust(dist(vorticity.data.frame, method = "euclidean"), method = "ward.D2" )
plot(hc5, cex = 0.6, hang = -1)

# Cut tree into 4 groups
k <- 4
sub_grp <- cutree(hc5, k = k)

#echo.cluster <- echo %>%
#mutate(cluster = sub_grp)

vorticity.data.cluster <- echo %>% mutate(cluster = sub_grp)


plot(hc5, cex=0.6)
rect.hclust(hc5, k = k, border = 2:5)

fviz_cluster(list(data = vorticity.data, cluster = sub_grp))


```



```{r}


palette(alpha(brewer.pal(9, 'Set1'), 0.5))
plot(vorticity.data, col=sub_grp, pch=16)



```



```{r}


# Cluster sizes
sapply(split(vorticity.data.cluster, sub_grp), nrow)


# on scaled data
vorticity.cluster <- split(data.frame(vorticity.data), sub_grp)

(vorticity.cluster.colmeans <- sapply(vorticity.cluster, colMeans))


# on unsacled data

vorticity.cluster.unscaled <- split(data.frame(vorticity.data.cluster[,c(45:52, 65)]), sub_grp)
(voriticy.cluster.unscaled.colmeans <- (sapply(vorticity.cluster.unscaled, colMeans)))

clust <- names(sort(table(sub_grp)))

# First cluster
#row.names(echo.cluster[sub_grp==clust[1],])
# Second Cluster
#row.names(echo.cluster[sub_grp==clust[2],])
# Third Cluster
#row.names(echo.cluster[sub_grp==clust[3],])

for(i in 1:k){
  cat(paste('# Cluster', i, "\n"))
  r <- row.names(vorticity.data.cluster[sub_grp==clust[i],])
  cat(r, "\n\n")
}

```


# compare vars in 

```{r}

vorticity.data.cluster[vorticity.data.cluster$cluster==unique(sub_grp)[1],c(10,24)]
vorticity.data.cluster[vorticity.data.cluster$cluster==unique(sub_grp)[2],c(10,24)]
vorticity.data.cluster[vorticity.data.cluster$cluster==unique(sub_grp)[3],c(10,24)]
vorticity.data.cluster[vorticity.data.cluster$cluster==unique(sub_grp)[4],c(10,24)]



```

## checking 3rd cluster
```{r}

cluster3 <- vorticity.data.cluster[vorticity.data.cluster$cluster == 3,]

cluster3$Gender <- factor(cluster3$Gender)
cluster3$NYHA <- factor(cluster3$NYHA)
cluster3$Etiology <- factor(cluster3$Etiology)

summary(cluster3)

```


# Analysis of demographics with cluster
# Chi square Test
      
```{r}
echo.table <- list()

echo.chisq.fn <- function(x){
  
  for(i in 1:length(x)){
    
    chi.var.name <- colnames(vorticity.data.cluster[x[i]])
    
    echo.table[[chi.var.name]] <- table(cluster = vorticity.data.cluster$cluster, Var = vorticity.data.cluster[[chi.var.name]])
    
    cat("Var name: ", chi.var.name, "\n")
    cat("------------------------------\n\n")
    
    cat("2-way Table\n")
    cat("============\n")
    print(echo.table[[chi.var.name]])
    cat("\n\n\n")
    
    cat("Chi-Square test\n")
    cat("================\n\n")
    cat(chi.var.name)
    echo.chisq.test <- chisq.test(echo.table[[chi.var.name]])
    
    print(echo.chisq.test)
    
    cat("\n\n")
    boxplot(vorticity.data.cluster[[chi.var.name]] ~ vorticity.data.cluster$cluster, 
            xlab = "Cluster", 
            ylab = chi.var.name, 
            main = paste("Cluster by ", chi.var.name))
    
    cat("\n\n=======================================================================\n\n")
  }
  
  
} 



chisq.cols <- c(4, 9, 24, 61:64)
echo.chisq.fn(chisq.cols)



```



```{r}

#age range
vorticity.data.cluster$age.range <- cut(vorticity.data.cluster$Age, breaks=c(0,40, 60, 80, 200), right = FALSE, labels = c("1", "2", "3", "4"))



# Age range by cluster
# 1 : 0-39
# 2:  40 - 59
# 3:  60 - 79
# 4:  80 +

cat("Age range by cluster
# 1 : 0-39
# 2:  40 - 59
# 3:  60 - 79
# 4:  80 +")

age.table <- table(cluster = vorticity.data.cluster$cluster, age.range = vorticity.data.cluster$age.range)
age.table

chisq.test(age.table)


```



# ANOVA of all continuous variables
```{r}


echo.aov.fn <- function(x){
    
    for(i in 1:length(x)){
      
      var.name <- colnames(vorticity.data.cluster[x[i]])
      echo.aov[[var.name]] <- aov(vorticity.data.cluster[[var.name]] ~ as.factor(vorticity.data.cluster$cluster))
      
      # Show the variable name
      cat("==============================================================================\n")
      cat(var.name,"\n")
      
      
      # Print the p-value
      cat(paste("P-value: ", summary(echo.aov[[var.name]])[[1]][["Pr(>F)"]][[1]]))
      
      
        if(summary(echo.aov[[var.name]])[[1]][["Pr(>F)"]][[1]] <= 0.05){
          
          cat("\n\nANOVA\n")
          cat("------\n")
          cat('var.name: ', var.name, '\n')
          cat("=============================\n\n")
          
          print(echo.aov[[var.name]])
          
          cat("\n\n")
          # Perform Tukey HSD Test
          tukey <- TukeyHSD(echo.aov[[var.name]])
          print(tukey)
          
        }
        else{
          cat("  Not Significant\n\n")
        }
      
      
      cat("==============================================================================\n\n\n\n") 
    
     }
  
    return("Done")
}
echo.aov <- list()
columns <- c(3, 5:8,11:23,25:35)
echo.aov.fn(columns)



# Significant
# EchoLA, EchoDd, EchoDs, EchoEDV, EchoESV, EchoEF, TimeTMFDecT, EchSepTDIe, EchoAveTDIe, EchoLVM, echolvmass

```















